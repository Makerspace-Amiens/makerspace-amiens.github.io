{% comment %}
  === Cards Include ===
  G√©n√®re une grille de cartes √† partir d'une collection Jekyll (docs, projects, ressources‚Ä¶),
  avec la possibilit√© de filtrer ou de composer manuellement des s√©lections sp√©cifiques.

  ===================================
  üß≠ UTILISATION G√âN√âRALE
  ===================================

  {% include card_collections.html %}
    ‚Üí Affiche toutes les cartes de la collection courante (ou "docs" par d√©faut).

  {% include card_collections.html collection="projects" %}
    ‚Üí Force l'utilisation d'une autre collection.

  {% include card_collections.html sort="title" %}
    ‚Üí Trie par un champ particulier (ex. title, date, order‚Ä¶).

  {% include card_collections.html type="tutorial,howto" %}
    ‚Üí Filtre les items selon leur type (OU logique).

  {% include card_collections.html tag="fabrication-additive,modelisation-3d" %}
    ‚Üí Filtre selon des tags (ET logique).

  {% include card_collections.html type="tutorial" tag="fabrication-additive" %}
    ‚Üí Combine les deux (type OU, tag ET).

  ===================================
  üß© NOUVEAUT√â : COMPOSITION MANUELLE
  ===================================

  {% include card_collections.html
      items="/projects/otto,/docs/impression-3d,/ressources/laser-settings"
      title="S√©lection du MakerSpace"
      description="Quelques ressources mises en avant"
  %}

  ‚Üí Affiche uniquement les pages list√©es dans "items", dans l‚Äôordre exact fourni.
  ‚Üí Peut piocher dans n‚Äôimporte quelle collection.
  ‚Üí Ignore totalement les filtres type/tag quand "items" est utilis√©.

  ===================================
  ‚öôÔ∏è PRIORIT√â DES PARAM√àTRES
  ===================================
    1Ô∏è‚É£ include.items       ‚Üí s√©lection manuelle (ordre strict)
    2Ô∏è‚É£ include.collection  ‚Üí collection forc√©e
    3Ô∏è‚É£ page.collection     ‚Üí collection d√©duite de la page
    4Ô∏è‚É£ "docs"              ‚Üí collection par d√©faut
{% endcomment %}

{% assign collection_name = include.collection | default: page.collection | default: "docs" %}
{% assign raw_items = site[collection_name] %}
{% assign sorted_items = "" %}

{%- comment -%}
  === 1. S√©lection manuelle explicite (prioritaire) ===
{%- endcomment -%}
{% if include.items %}
  {% assign manual_items = include.items | split: "," %}
  {% assign selected_items = "" | split: "" %}

  {% for path in manual_items %}
    {% assign path = path | strip %}
    {% assign doc = site.pages | where: "url", path | first %}
    {% if doc == nil %}
      {% assign doc = site.docs | where: "url", path | first %}
    {% endif %}
    {% if doc == nil %}
      {% assign doc = site.projects | where: "url", path | first %}
    {% endif %}
    {% if doc == nil %}
      {% assign doc = site.ressources | where: "url", path | first %}
    {% endif %}
    {% if doc %}
      {% assign selected_items = selected_items | push: doc %}
    {% endif %}
  {% endfor %}

  {% assign sorted_items = selected_items %}
{% elsif raw_items %}
  {% assign sorted_items = raw_items | sort: include.sort %}
{% endif %}

<div class="column is-fullwidth">
  <div class="content">
    {% if include.title %}
      <h2>{{ include.title }}</h2>
    {% endif %}
    {% if include.description %}
      <p>{{ include.description }}</p>
    {% endif %}
  </div>
</div>

<div class="columns is-multiline">

  {% assign filter_types = include.type | default: "" | split: "," %}
  {% assign filter_tags = include.tag | default: "" | split: "," %}

  {% for item in sorted_items %}
    {% assign type_match = false %}
    {% assign tag_match = true %}

    {%- comment -%}
      === 2. Filtrage TYPE (OU logique)
      Si aucun type sp√©cifi√© ‚Üí tout passe
    {%- endcomment -%}
    {% if filter_types == empty or include.type == nil %}
      {% assign type_match = true %}
    {% else %}
      {% for t in filter_types %}
        {% assign t = t | strip %}
        {% if item.type contains t %}
          {% assign type_match = true %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {%- comment -%}
      === 3. Filtrage TAG (ET logique)
      Si aucun tag sp√©cifi√© ‚Üí tout passe
    {%- endcomment -%}
    {% if filter_tags == empty or include.tag == nil %}
      {% assign tag_match = true %}
    {% else %}
      {% for tag in filter_tags %}
        {% assign tag = tag | strip %}
        {% unless item.tags contains tag %}
          {% assign tag_match = false %}
        {% endunless %}
      {% endfor %}
    {% endif %}

    {%- comment -%}
      === 4. Affichage de la carte ===
      - Si "include.items" est utilis√© ‚Üí type/tag sont ignor√©s
      - Sinon, on v√©rifie les filtres logiques
    {%- endcomment -%}
    {% if include.items or (type_match and tag_match) %}
      <div class="column is-4-desktop is-6-tablet">
        {% if item.external_link %}
          <a href="{{ item.external_link }}">
        {% else %}
          <a href="{{ item.url | relative_url }}">
        {% endif %}
          <div class="card">
            {% if item.image %}
              {% capture image-url %}{{ site.baseurl }}{{ item.url }}{{ item.image }}{% endcapture %}
              <div class="card-image">
                <figure class="image is-fullwidth fixed-image">
                  <img src="{{ image-url }}" alt="{{ item.title }}" />
                </figure>
              </div>
            {% endif %}
            <div class="card-content" style="background-color: {{ item.background_color | default: '#FFFFFF' }}">
              <p class="title is-5">{{ item.title }}</p>
              <p class="subtitle is-6">{{ item.subtitle | truncate: 60 }}</p>
            </div>
          </div>
        </a>
      </div>
    {% endif %}
  {% endfor %}

  {% if sorted_items == "" %}
    <div class="column is-12">
      <p><em>Aucune collection trouv√©e pour "{{ collection_name }}".</em></p>
    </div>
  {% endif %}
</div>

<div>
  <div class="divider is-right"><a href="#">Top ‚Üë</a></div>
</div>
